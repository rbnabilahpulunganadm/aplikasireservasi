<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Manajemen Klinik Nabilah Pulungan</title>
    
    <!-- Memuat Library Eksternal -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #16a085; /* Hijau Mint */
            --secondary-color: #2c3e50; /* Abu-abu Tua */
            --background-color: #ecf0f1; /* Abu-abu Sangat Terang */
            --text-color: #34495e; /* Abu-abu Gelap */
            --card-bg-color: #ffffff;
            --border-color: #bdc3c7;
            --danger-color: #e74c3c;
            --danger-hover-color: #c0392b;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding: 0;
            color: var(--text-color);
            display: flex;
        }

        #sidebar {
            width: 250px;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: fixed;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        #sidebar h1 {
            font-size: 1.4em;
            padding: 20px;
            margin: 0;
            background-color: rgba(0,0,0,0.2);
            text-align: center;
        }

        #sidebar nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
        }

        #sidebar nav li a {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px 25px;
            color: #ecf0f1;
            text-decoration: none;
            border-bottom: 1px solid #34495e;
            transition: background-color 0.3s, padding-left 0.3s;
            font-weight: 500;
        }
        
        #sidebar nav li a i { font-size: 1.3em; }

        #sidebar nav li a:hover, #sidebar nav li a.active {
            background-color: var(--primary-color);
            color: white;
            padding-left: 30px;
        }

        #main-content {
            margin-left: 250px;
            padding: 30px;
            width: calc(100% - 250px);
            overflow-y: auto;
        }

        .page { display: none; }
        .page.active { display: block; }

        h2 {
            color: var(--secondary-color);
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 10px;
            font-weight: 600;
        }

        .card {
            background-color: var(--card-bg-color);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e0e0e0;
        }

        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        input[type="text"], input[type="date"], input[type="time"], input[type="tel"], input[type="number"], select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(22, 160, 133, 0.2);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color 0.3s, transform 0.2s;
        }
        button:hover {
            background-color: #117a65;
            transform: translateY(-2px);
        }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: var(--danger-hover-color); }
        .btn-secondary { background-color: #7f8c8d; }
        .btn-secondary:hover { background-color: #616a6b; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 15px;
            border: 1px solid #e0e0e0;
            text-align: left;
        }
        th {
            background-color: #f9f9f9;
            font-weight: 600;
            color: var(--secondary-color);
        }
        tbody tr:nth-child(even) { background-color: #fdfdfd; }
        tbody tr:hover { background-color: #f1f8f6; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }
        .stat-item {
            background-color: var(--card-bg-color);
            border-left: 5px solid var(--primary-color);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .stat-item h3 { margin: 0 0 10px 0; font-size: 1.1em; color: var(--secondary-color); }
        .stat-item p { margin: 0; font-size: 2em; font-weight: 700; color: var(--primary-color); }

        .chart-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-top: 25px;
        }

        .modal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.6);
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border: 1px solid #888;
            width: 90%;
            max-width: 700px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: slideIn 0.4s;
        }
        .close-button {
            color: #aaa; float: right; font-size: 32px; font-weight: bold; cursor: pointer;
        }
        .close-button:hover, .close-button:focus { color: black; }
        
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        @keyframes slideIn { from {transform: translateY(-50px);} to {transform: translateY(0);} }

        /* Indikator Loading */
        #loader {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            justify-content: center;
            align-items: center;
        }
        #loader p {
            background-color: var(--secondary-color);
            color: white;
            padding: 20px 30px;
            border-radius: 8px;
            font-size: 1.2em;
        }

        @media (max-width: 768px) {
            #sidebar { display: none; }
            #main-content { margin-left: 0; width: 100%; padding: 15px; }
            .chart-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Indikator Loading -->
    <div id="loader"><p>Memuat Data...</p></div>

    <div id="sidebar">
        <h1>Klinik Nabilah</h1>
        <nav>
            <ul>
                <li><a href="#" class="nav-link active" data-page="dashboard"><i class="ph-bold ph-chart-pie-slice"></i>Dashboard</a></li>
                <li><a href="#" class="nav-link" data-page="reservasi"><i class="ph-bold ph-calendar-plus"></i>Buat Reservasi</a></li>
                <li><a href="#" class="nav-link" data-page="daftar-reservasi"><i class="ph-bold ph-list-checks"></i>Daftar Reservasi</a></li>
                <li><a href="#" class="nav-link" data-page="pasien"><i class="ph-bold ph-users-three"></i>Manajemen Pasien</a></li>
                <li><a href="#" class="nav-link" data-page="laporan"><i class="ph-bold ph-file-text"></i>Laporan</a></li>
                <li><a href="#" class="nav-link" data-page="layanan"><i class="ph-bold ph-wrench"></i>Manajemen Layanan</a></li>
                <li><a href="#" class="nav-link" data-page="terapis"><i class="ph-bold ph-first-aid-kit"></i>Manajemen Terapis</a></li>
                <li><a href="#" class="nav-link" data-page="pengaturan"><i class="ph-bold ph-gear"></i>Pengaturan</a></li>
            </ul>
        </nav>
    </div>

    <main id="main-content">
        <section id="dashboard" class="page active">
            <h2><i class="ph-bold ph-chart-pie-slice"></i> Dashboard Statistik</h2>
            <div class="card">
                <div class="form-group">
                    <label for="dashboard-filter">Tampilkan Statistik Untuk Periode:</label>
                    <select id="dashboard-filter">
                        <option value="harian">Hari Ini</option>
                        <option value="pekanan">Pekan Ini</option>
                        <option value="bulanan">Bulan Ini</option>
                        <option value="tahunan">Tahun Ini</option>
                    </select>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-item"><h3>Total Kunjungan</h3><p id="stat-total-kunjungan">0</p></div>
                <div class="stat-item"><h3>Total Pendapatan</h3><p id="stat-total-pendapatan">Rp 0</p></div>
                <div class="stat-item"><h3>Pasien Terdaftar</h3><p id="stat-total-pasien">0</p></div>
                <div class="stat-item"><h3>Layanan Favorit</h3><p id="stat-layanan-favorit">-</p></div>
            </div>
            
            <div class="chart-grid">
                <div class="card">
                    <h3>Grafik Kunjungan per Jam</h3>
                    <canvas id="jamSibukChart"></canvas>
                </div>
                <div class="card">
                    <h3>Komposisi Layanan</h3>
                    <canvas id="layananChart"></canvas>
                </div>
            </div>

            <div class="stats-grid" style="margin-top: 20px;">
                <div class="card"><h3>Peringkat Domisili Pasien</h3><table id="tabel-domisili"><thead><tr><th>Domisili</th><th>Jumlah</th></tr></thead><tbody></tbody></table></div>
                <div class="card"><h3>Peringkat Usia Pasien</h3><table id="tabel-usia"><thead><tr><th>Kelompok Usia</th><th>Jumlah</th></tr></thead><tbody></tbody></table></div>
                <div class="card"><h3>Peringkat Keluhan Pasien</h3><table id="tabel-keluhan"><thead><tr><th>Keluhan</th><th>Jumlah</th></tr></thead><tbody></tbody></table></div>
            </div>
        </section>

        <section id="reservasi" class="page">
            <h2><i class="ph-bold ph-calendar-plus"></i> Form Reservasi Pasien</h2>
            <div class="card">
                <form id="form-reservasi">
                    <div class="form-group"><label>Jenis Pasien</label><select id="jenis-pasien"><option value="lama">Pasien Lama (Sudah Punya RME)</option><option value="baru">Pasien Baru</option></select></div>
                    <div id="form-pasien-lama"><div class="form-group"><label for="search-pasien">Cari Pasien (Nama atau No. RME)</label><input type="text" id="search-pasien" placeholder="Ketik nama atau No. RME..."><select id="select-pasien-lama" style="margin-top: 10px;"></select></div></div>
                    <div id="form-pasien-baru" style="display: none;">
                        <h3>Data Pasien Baru</h3>
                        <div class="form-group"><label for="nama-pasien-baru">Nama Lengkap</label><input type="text" id="nama-pasien-baru"></div>
                        <div class="form-group"><label for="nik-pasien-baru">NIK (Nomor Induk Kependudukan) - Opsional</label><input type="text" id="nik-pasien-baru" placeholder="Jika diisi, akan digunakan untuk No. RME"></div>
                        <div class="form-group"><label for="telepon-pasien-baru">No. Telepon/HP</label><input type="tel" id="telepon-pasien-baru"></div>
                        <div class="form-group"><label for="tgl-lahir-pasien-baru">Tanggal Lahir</label><input type="date" id="tgl-lahir-pasien-baru"></div>
                        <div class="form-group"><label for="alamat-pasien-baru">Domisili/Alamat (Cukup Nama Kota/Kecamatan)</label><input type="text" id="alamat-pasien-baru" placeholder="Contoh: Padang Sidempuan"></div>
                    </div>
                    <hr style="margin: 20px 0; border: 1px solid #eee;">
                    <h3>Detail Reservasi</h3>
                    <div class="form-group"><label for="tanggal-reservasi">Tanggal Kunjungan</label><input type="date" id="tanggal-reservasi" required></div>
                    <div class="form-group"><label for="jam-reservasi">Jam Kunjungan</label><input type="time" id="jam-reservasi" required></div>
                    <div class="form-group"><label for="layanan-reservasi">Pilih Layanan</label><select id="layanan-reservasi" required></select></div>
                    <div class="form-group"><label for="treatment-reservasi">Pilih Treatment/Program</label><select id="treatment-reservasi" required></select></div>
                    <div class="form-group"><label for="terapis-reservasi">Pilih Terapis</label><select id="terapis-reservasi" required></select></div>
                    <div class="form-group"><label for="keluhan-pasien">Keluhan Utama (jika ada)</label><textarea id="keluhan-pasien" rows="3" placeholder="Contoh: Pegal-pegal, bayi susah tidur, dll"></textarea></div>
                    <button type="submit">Simpan Reservasi</button>
                </form>
            </div>
        </section>

        <section id="daftar-reservasi" class="page">
            <h2><i class="ph-bold ph-list-checks"></i> Daftar Semua Reservasi</h2>
            <div class="card">
                <table><thead><tr><th>Tgl Kunjungan</th><th>No. RME</th><th>Nama Pasien</th><th>Layanan</th><th>Terapis</th><th>Biaya</th><th>Aksi</th></tr></thead><tbody id="tabel-reservasi-body"></tbody></table>
            </div>
        </section>

        <section id="pasien" class="page">
            <h2><i class="ph-bold ph-users-three"></i> Manajemen Data Pasien (RME)</h2>
            <div class="card">
                 <table><thead><tr><th>No. RME</th><th>Nama</th><th>Tgl Lahir</th><th>Alamat</th><th>Telepon</th><th>Aksi</th></tr></thead><tbody id="tabel-pasien-body"></tbody></table>
            </div>
        </section>
        
        <section id="laporan" class="page">
            <h2><i class="ph-bold ph-file-text"></i> Laporan Kunjungan</h2>
            <div class="card">
                <h3>Pilih Rentang Waktu Laporan</h3>
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group" style="flex: 1;"><label for="laporan-start-date">Dari Tanggal</label><input type="date" id="laporan-start-date"></div>
                    <div class="form-group" style="flex: 1;"><label for="laporan-end-date">Sampai Tanggal</label><input type="date" id="laporan-end-date"></div>
                </div>
                <button id="btn-generate-laporan">Buat Laporan</button>
                <button id="btn-export-excel" style="margin-left: 10px;" class="btn-secondary" disabled>Ekspor ke Excel (CSV)</button>
                <button id="btn-export-pdf" style="margin-left: 10px;" class="btn-secondary" disabled>Ekspor ke PDF</button>
            </div>
            <div class="card" id="area-laporan" style="display:none;">
                <h3 id="judul-laporan">Hasil Laporan</h3>
                <p id="summary-laporan" style="font-weight: 500;"></p>
                <table id="tabel-laporan"><thead><tr><th>Tanggal</th><th>No. RME</th><th>Nama Pasien</th><th>Layanan</th><th>Treatment</th><th>Terapis</th><th>Keluhan</th><th>Biaya</th></tr></thead><tbody></tbody></table>
            </div>
        </section>

        <section id="layanan" class="page">
            <h2><i class="ph-bold ph-wrench"></i> Manajemen Layanan</h2>
            <div class="card"><form id="form-tambah-layanan"><div class="form-group"><label for="nama-layanan-baru">Nama Layanan</label><input type="text" id="nama-layanan-baru" required></div><button type="submit">Tambah Layanan</button></form></div>
            <div class="card"><h3>Daftar Layanan & Treatment</h3><div id="daftar-layanan-treatment"></div></div>
        </section>
        <section id="terapis" class="page">
            <h2><i class="ph-bold ph-first-aid-kit"></i> Manajemen Terapis</h2>
            <div class="card"><form id="form-tambah-terapis"><div class="form-group"><label for="nama-terapis-baru">Nama Terapis</label><input type="text" id="nama-terapis-baru" required></div><button type="submit">Tambah Terapis</button></form></div>
            <div class="card"><h3>Daftar Terapis</h3><table><thead><tr><th>Nama Terapis</th><th>Aksi</th></tr></thead><tbody id="tabel-terapis-body"></tbody></table></div>
        </section>
        
        <section id="pengaturan" class="page">
            <h2><i class="ph-bold ph-gear"></i> Pengaturan Data</h2>
            <div class="card"><h3>Backup Data</h3><p>Simpan semua data ke dalam sebuah file di komputer Anda.</p><button id="btn-backup">Backup Data Sekarang</button></div>
            <div class="card"><h3>Restore Data</h3><p>Pulihkan data dari file backup.</p><input type="file" id="file-restore" accept=".json"><button id="btn-restore" style="margin-top:10px;">Restore Data</button></div>
            <div class="card" style="border: 2px solid var(--danger-color);"><h3>Reset Aplikasi</h3><p style="color: var(--danger-color); font-weight: bold;">PERINGATAN: Tindakan ini akan menghapus SEMUA data secara permanen!</p><button id="btn-reset" class="btn-danger">Reset Semua Data</button></div>
        </section>
    </main>

    <div id="modal-tambah-treatment" class="modal"><div class="modal-content"><span class="close-button">&times;</span><h3>Tambah Treatment</h3><form id="form-tambah-treatment"><input type="hidden" id="id-layanan-untuk-treatment"><div class="form-group"><label for="nama-treatment-baru">Nama Treatment</label><input type="text" id="nama-treatment-baru" required></div><div class="form-group"><label for="harga-treatment-baru">Harga (Rp)</label><input type="number" id="harga-treatment-baru" required></div><button type="submit">Simpan</button></form></div></div>
    <div id="modal-riwayat-pasien" class="modal"><div class="modal-content"><span class="close-button">&times;</span><h2 id="riwayat-nama-pasien">Riwayat Kunjungan</h2><div id="konten-riwayat-pasien"></div></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            let services = [], patients = [], reservations = [], therapists = [];
            let jamSibukChart, layananChart;
            let currentReportData = [];

            const loader = document.getElementById('loader');

            function showLoader() { loader.style.display = 'flex'; }
            function hideLoader() { loader.style.display = 'none'; }

            function initializeApp() {
                services = JSON.parse(localStorage.getItem('klinik_services')) || [
                    { id: 1, name: 'Baby Spa', treatments: [{id: 101, name: 'Pijat Bayi', price: 75000}, {id: 102, name: 'Renang Bayi', price: 80000}] },
                    { id: 2, name: 'Mom Spa', treatments: [{id: 201, name: 'Pijat Laktasi', price: 100000}] },
                    { id: 3, name: 'Bumil Spa', treatments: [{id: 301, name: 'Pijat Hamil', price: 150000}] },
                    { id: 4, name: 'Bersalin Normal', treatments: [{id: 401, name: 'Paket Persalinan', price: 2500000}]},
                    { id: 5, name: 'Tindik dr Evoo', treatments: [{id: 501, name: 'Tindik Bayi', price: 150000}]},
                    { id: 6, name: 'Senam Sehat', treatments: [{id: 601, name: 'Senam Hamil', price: 50000}]},
                    { id: 7, name: 'Home Care', treatments: [{id: 701, name: 'Kunjungan Rumah', price: 200000}]}
                ];
                patients = JSON.parse(localStorage.getItem('klinik_patients')) || [];
                reservations = JSON.parse(localStorage.getItem('klinik_reservations')) || [];
                therapists = JSON.parse(localStorage.getItem('klinik_therapists')) || ['Bidan Nabilah', 'Terapis Indah'];
                
                saveAllData(); 
                renderAll();
                setupEventListeners();
            }

            function saveAllData() {
                localStorage.setItem('klinik_services', JSON.stringify(services));
                localStorage.setItem('klinik_patients', JSON.stringify(patients));
                localStorage.setItem('klinik_reservations', JSON.stringify(reservations));
                localStorage.setItem('klinik_therapists', JSON.stringify(therapists));
            }

            function renderAll() {
                renderLayananList();
                renderReservasiOptions();
                renderReservasiTable();
                renderPatientTable();
                renderTerapisTable();
                renderTerapisOptions();
                updateDashboard();
            }
            
            function setupEventListeners() {
                document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', handleNavClick));
                document.getElementById('form-tambah-layanan').addEventListener('submit', handleAddService);
                document.getElementById('form-tambah-treatment').addEventListener('submit', handleAddTreatment);
                document.getElementById('form-tambah-terapis').addEventListener('submit', handleAddTherapist);
                document.getElementById('form-reservasi').addEventListener('submit', handleAddReservation);
                document.getElementById('jenis-pasien').addEventListener('change', togglePatientForm);
                document.getElementById('search-pasien').addEventListener('keyup', (e) => populatePasienLamaSelect(e.target.value));
                document.getElementById('layanan-reservasi').addEventListener('change', updateTreatmentOptions);
                document.getElementById('dashboard-filter').addEventListener('change', updateDashboard);
                document.getElementById('btn-backup').addEventListener('click', handleBackup);
                document.getElementById('btn-restore').addEventListener('click', handleRestore);
                document.getElementById('btn-reset').addEventListener('click', handleReset);
                document.querySelectorAll('.modal .close-button').forEach(btn => btn.addEventListener('click', (e) => e.target.closest('.modal').style.display = 'none'));
                document.getElementById('btn-generate-laporan').addEventListener('click', generateReport);
                document.getElementById('btn-export-excel').addEventListener('click', exportToExcel);
                document.getElementById('btn-export-pdf').addEventListener('click', exportToPDF);
            }

            function handleNavClick(e) {
                e.preventDefault();
                const pageId = e.currentTarget.getAttribute('data-page');
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                e.currentTarget.classList.add('active');
                if (pageId === 'dashboard') {
                    updateDashboard();
                }
            }

            function handleAddReservation(e) {
                e.preventDefault();
                let patientIdRME, patientName;
                const jenisPasien = document.getElementById('jenis-pasien').value;

                if (jenisPasien === 'baru') {
                    const namaBaru = document.getElementById('nama-pasien-baru').value.trim();
                    const telpBaru = document.getElementById('telepon-pasien-baru').value.trim();
                    if (!namaBaru || !telpBaru) {
                        alert("Nama dan Nomor Telepon wajib diisi untuk pasien baru.");
                        return;
                    }
                    const newPatient = {
                        id: Date.now(),
                        name: namaBaru,
                        nik: document.getElementById('nik-pasien-baru').value.trim(),
                        phone: telpBaru,
                        dob: document.getElementById('tgl-lahir-pasien-baru').value,
                        address: document.getElementById('alamat-pasien-baru').value.trim(),
                    };
                    newPatient.idRME = generateRME(newPatient); 
                    patients.push(newPatient);
                    patientIdRME = newPatient.idRME;
                    patientName = newPatient.name;
                    alert(`Pasien baru berhasil dibuat dengan No. RME: ${patientIdRME}`);
                } else {
                    patientIdRME = document.getElementById('select-pasien-lama').value;
                    if (!patientIdRME) {
                        alert('Silakan pilih pasien lama terlebih dahulu.');
                        return;
                    }
                    const patient = patients.find(p => p.idRME === patientIdRME);
                    patientName = patient.name;
                }
                
                const treatmentSelect = document.getElementById('treatment-reservasi');
                const treatmentId = parseInt(treatmentSelect.value);
                if (isNaN(treatmentId)) {
                    alert('Silakan pilih treatment/program terlebih dahulu.');
                    return;
                }
                const selectedTreatmentOption = treatmentSelect.options[treatmentSelect.selectedIndex];

                const therapist = document.getElementById('terapis-reservasi').value;
                if (!therapist) {
                    alert('Silakan pilih terapis terlebih dahulu.');
                    return;
                }
                
                const newReservation = {
                    id: Date.now(), patientIdRME, patientName,
                    reservationDate: document.getElementById('tanggal-reservasi').value,
                    reservationTime: document.getElementById('jam-reservasi').value,
                    serviceId: parseInt(document.getElementById('layanan-reservasi').value),
                    serviceName: document.getElementById('layanan-reservasi').options[document.getElementById('layanan-reservasi').selectedIndex].text,
                    treatmentId,
                    treatmentName: selectedTreatmentOption.text.split(' (')[0],
                    price: parseInt(selectedTreatmentOption.dataset.price),
                    therapist,
                    complaint: document.getElementById('keluhan-pasien').value.trim()
                };
                
                reservations.push(newReservation);
                saveAllData();
                alert('Reservasi berhasil disimpan!');
                document.getElementById('form-reservasi').reset();
                document.getElementById('jenis-pasien').value = 'lama';
                togglePatientForm({target: {value: 'lama'}});
                renderAll();
            }

            // --- FUNGSI RME DIPERBAIKI ---
            function getNextPatientSequence() {
                if (patients.length === 0) return 1;
                const maxNum = patients.reduce((max, p) => {
                    const num = parseInt(p.idRME.split('-')[1]);
                    return num > max ? num : max;
                }, 0);
                return maxNum + 1;
            }

            function generateRME(patientData) {
                const nomorUrut = String(getNextPatientSequence()).padStart(3, '0'); 
                const identitas = patientData.nik || patientData.phone;
                return `RME-${nomorUrut}-${identitas}`;
            }

            function renderPatientTable() {
                const tabelPasienBody = document.getElementById('tabel-pasien-body');
                tabelPasienBody.innerHTML = '';
                patients.forEach(patient => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${patient.idRME}</td><td>${patient.name}</td>
                        <td>${patient.dob || '-'}</td><td>${patient.address || '-'}</td>
                        <td>${patient.phone || '-'}</td>
                        <td>
                            <button onclick="showPatientHistory('${patient.idRME}')" class="btn-secondary" style="padding: 5px 10px; font-size: 0.9em;">Riwayat</button>
                            <button onclick="deletePatient('${patient.idRME}')" class="btn-danger" style="padding: 5px 10px; font-size: 0.9em; margin-left: 5px;">Hapus</button>
                        </td>`;
                    tabelPasienBody.appendChild(row);
                });
            }
            
            window.showPatientHistory = function(idRME) {
                const patient = patients.find(p => p.idRME === idRME);
                if (!patient) return;
                const patientReservations = reservations.filter(r => r.patientIdRME === idRME).sort((a, b) => new Date(b.reservationDate) - new Date(a.reservationDate));
                const modal = document.getElementById('modal-riwayat-pasien');
                document.getElementById('riwayat-nama-pasien').textContent = `Riwayat Kunjungan - ${patient.name}`;
                const contentDiv = document.getElementById('konten-riwayat-pasien');
                if (patientReservations.length === 0) {
                    contentDiv.innerHTML = '<p>Belum ada riwayat kunjungan.</p>';
                } else {
                    let tableHTML = '<table><thead><tr><th>Tanggal</th><th>Layanan</th><th>Treatment</th><th>Keluhan</th><th>Terapis</th><th>Biaya</th></tr></thead><tbody>';
                    patientReservations.forEach(r => {
                        tableHTML += `<tr><td>${r.reservationDate}</td><td>${r.serviceName}</td><td>${r.treatmentName}</td><td>${r.complaint || '-'}</td><td>${r.therapist}</td><td>Rp ${r.price.toLocaleString('id-ID')}</td></tr>`;
                    });
                    tableHTML += '</tbody></table>';
                    contentDiv.innerHTML = tableHTML;
                }
                modal.style.display = 'block';
            }
            
            // --- FUNGSI DASHBOARD DIOPTIMALKAN ---
            function updateDashboard() {
                showLoader();
                // Gunakan setTimeout untuk memberi waktu pada UI untuk menampilkan loader sebelum proses berat dimulai
                setTimeout(() => {
                    const filter = document.getElementById('dashboard-filter').value;
                    const { startDate, endDate } = getFilterDates(filter);
                    const filteredReservations = reservations.filter(r => {
                        const resDate = new Date(r.reservationDate);
                        return resDate >= startDate && resDate <= endDate;
                    });
                    
                    document.getElementById('stat-total-kunjungan').textContent = filteredReservations.length;
                    document.getElementById('stat-total-pasien').textContent = patients.length;
                    const totalPendapatan = filteredReservations.reduce((sum, r) => sum + r.price, 0);
                    document.getElementById('stat-total-pendapatan').textContent = `Rp ${totalPendapatan.toLocaleString('id-ID')}`;
                    
                    const layananCounts = filteredReservations.reduce((acc, r) => { acc[r.serviceName] = (acc[r.serviceName] || 0) + 1; return acc; }, {});
                    const layananFavorit = Object.keys(layananCounts).length > 0 ? Object.entries(layananCounts).sort((a,b) => b[1] - a[1])[0][0] : '-';
                    document.getElementById('stat-layanan-favorit').textContent = layananFavorit;

                    // SEMUA STATISTIK SEKARANG MENGGUNAKAN DATA YANG SUDAH DIFILTER
                    updateJamSibukChart(filteredReservations);
                    updateLayananChart(filteredReservations);
                    updateDomisiliRanking(filteredReservations);
                    updateUsiaRanking(filteredReservations);
                    updateKeluhanRanking(filteredReservations);
                    
                    hideLoader();
                }, 50); // Delay 50ms
            }
            
            function updateLayananChart(data) {
                const ctx = document.getElementById('layananChart').getContext('2d');
                const layananCounts = data.reduce((acc, r) => { acc[r.serviceName] = (acc[r.serviceName] || 0) + 1; return acc; }, {});
                if (layananChart) layananChart.destroy();
                layananChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(layananCounts),
                        datasets: [{
                            label: 'Jumlah Kunjungan',
                            data: Object.values(layananCounts),
                            backgroundColor: ['#1abc9c', '#3498db', '#9b59b6', '#f1c40f', '#e67e22', '#e74c3c', '#34495e'],
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
                });
            }
            
            // --- FUNGSI LAPORAN DIPERBARUI ---
            function generateReport() {
                const startDate = document.getElementById('laporan-start-date').value;
                const endDate = document.getElementById('laporan-end-date').value;
                if (!startDate || !endDate) {
                    alert('Silakan pilih rentang tanggal laporan.');
                    return;
                }
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);

                currentReportData = reservations.filter(r => {
                    const resDate = new Date(r.reservationDate);
                    return resDate >= start && resDate <= end;
                });
                
                const tabelBody = document.getElementById('tabel-laporan').querySelector('tbody');
                tabelBody.innerHTML = '';
                let totalPendapatanLaporan = 0;
                currentReportData.forEach(r => {
                    totalPendapatanLaporan += r.price;
                    tabelBody.innerHTML += `<tr><td>${r.reservationDate}</td><td>${r.patientIdRME}</td><td>${r.patientName}</td><td>${r.serviceName}</td><td>${r.treatmentName}</td><td>${r.therapist}</td><td>${r.complaint || '-'}</td><td>${r.price.toLocaleString('id-ID')}</td></tr>`;
                });

                document.getElementById('judul-laporan').textContent = `Laporan Kunjungan (${startDate} s/d ${endDate})`;
                document.getElementById('summary-laporan').textContent = `Total ${currentReportData.length} kunjungan dengan total pendapatan Rp ${totalPendapatanLaporan.toLocaleString('id-ID')}.`;
                document.getElementById('area-laporan').style.display = 'block';
                document.getElementById('btn-export-excel').disabled = false;
                document.getElementById('btn-export-pdf').disabled = false;
            }

            function exportToExcel() {
                if (currentReportData.length === 0) { alert('Tidak ada data untuk diekspor.'); return; }
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Tanggal,No RME,Nama Pasien,Layanan,Treatment,Terapis,Keluhan,Biaya\r\n";
                currentReportData.forEach(r => {
                    let row = [r.reservationDate, r.patientIdRME, r.patientName, r.serviceName, r.treatmentName, r.therapist, `"${r.complaint || ''}"`, r.price].join(",");
                    csvContent += row + "\r\n";
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `laporan_klinik_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function exportToPDF() {
                if (currentReportData.length === 0) { alert('Tidak ada data untuk diekspor.'); return; }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'landscape' });
                const startDate = document.getElementById('laporan-start-date').value;
                const endDate = document.getElementById('laporan-end-date').value;
                
                doc.text(`Laporan Kunjungan Klinik Nabilah Pulungan (${startDate} s/d ${endDate})`, 14, 15);
                
                const tableColumn = ["Tanggal", "No RME", "Nama Pasien", "Layanan", "Treatment", "Terapis", "Keluhan", "Biaya"];
                const tableRows = [];
                currentReportData.forEach(r => {
                    const rowData = [r.reservationDate, r.patientIdRME, r.patientName, r.serviceName, r.treatmentName, r.therapist, r.complaint || '-', r.price.toLocaleString('id-ID')];
                    tableRows.push(rowData);
                });

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 20,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [44, 62, 80] } // Warna --secondary-color
                });
                doc.save(`laporan_klinik_${new Date().toISOString().slice(0,10)}.pdf`);
            }
            
            // --- KODE LAIN YANG TIDAK BERUBAH ---
            // (Kode di bawah ini adalah salinan dari versi sebelumnya, sengaja dipersingkat di sini untuk fokus pada perubahan)
            function handleAddService(e) { e.preventDefault(); const n = document.getElementById('nama-layanan-baru').value; if(n){services.push({id:Date.now(),name:n,treatments:[]});saveAllData();renderAll();e.target.reset();} }
            window.deleteService=function(id){if(confirm('Hapus layanan ini?')){services=services.filter(s=>s.id!==id);saveAllData();renderAll();}}
            window.openTambahTreatmentModal=function(id){document.getElementById('modal-tambah-treatment').style.display='block';document.getElementById('id-layanan-untuk-treatment').value=id;}
            function handleAddTreatment(e){e.preventDefault();const sId=parseInt(document.getElementById('id-layanan-untuk-treatment').value);const tName=document.getElementById('nama-treatment-baru').value;const tPrice=parseInt(document.getElementById('harga-treatment-baru').value);const s=services.find(s=>s.id===sId);if(s&&tName&&!isNaN(tPrice)){s.treatments.push({id:Date.now(),name:tName,price:tPrice});saveAllData();renderAll();document.getElementById('modal-tambah-treatment').style.display='none';e.target.reset();}}
            window.deleteTreatment=function(sId,tId){if(confirm('Hapus treatment ini?')){const s=services.find(s=>s.id===sId);if(s){s.treatments=s.treatments.filter(t=>t.id!==tId);saveAllData();renderAll();}}}
            function handleAddTherapist(e){e.preventDefault();const n=document.getElementById('nama-terapis-baru').value.trim();if(n&&!therapists.includes(n)){therapists.push(n);saveAllData();renderAll();e.target.reset();}else{alert('Nama terapis tidak boleh kosong atau sudah ada.');}}
            window.deleteTerapis=function(idx){if(confirm(`Hapus terapis "${therapists[idx]}"?`)){therapists.splice(idx,1);saveAllData();renderAll();}}
            function renderLayananList(){const c=document.getElementById('daftar-layanan-treatment');c.innerHTML='';services.forEach(s=>{const d=document.createElement('div');d.className='card';d.style.marginBottom='15px';let tH='<ul>';s.treatments.forEach(t=>{tH+=`<li>${t.name} (Rp ${t.price.toLocaleString('id-ID')}) <button class="btn-danger" style="padding:2px 5px;font-size:0.8em;margin-left:10px;" onclick="deleteTreatment(${s.id},${t.id})">Hapus</button></li>`});tH+='</ul>';d.innerHTML=`<h4>${s.name} <button class="btn-danger" style="padding:5px 8px;font-size:0.9em;margin-left:10px;" onclick="deleteService(${s.id})">Hapus</button></h4>${tH}<button class="btn-secondary" onclick="openTambahTreatmentModal(${s.id})">Tambah Treatment</button>`;c.appendChild(d);});}
            function renderReservasiOptions(){const sS=document.getElementById('layanan-reservasi');sS.innerHTML='<option value="">-- Pilih Layanan --</option>';services.forEach(s=>{const o=document.createElement('option');o.value=s.id;o.textContent=s.name;sS.appendChild(o);});}
            function renderTerapisOptions(){const tS=document.getElementById('terapis-reservasi');tS.innerHTML='<option value="">-- Pilih Terapis --</option>';therapists.forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;tS.appendChild(o);});}
            function renderTerapisTable(){const tB=document.getElementById('tabel-terapis-body');tB.innerHTML='';therapists.forEach((t,i)=>{const r=document.createElement('tr');r.innerHTML=`<td>${t}</td><td><button class="btn-danger" onclick="deleteTerapis(${i})">Hapus</button></td>`;tB.appendChild(r);});}
            function populatePasienLamaSelect(f=''){const s=document.getElementById('select-pasien-lama');s.innerHTML='<option value="">-- Pilih Pasien --</option>';const pF=patients.filter(p=>p.name.toLowerCase().includes(f.toLowerCase())||p.idRME.toLowerCase().includes(f.toLowerCase()));pF.forEach(p=>{const o=document.createElement('option');o.value=p.idRME;o.textContent=`${p.idRME} - ${p.name}`;s.appendChild(o);});}
            function renderReservasiTable(){const tB=document.getElementById('tabel-reservasi-body');tB.innerHTML='';const sR=[...reservations].sort((a,b)=>new Date(`${b.reservationDate}T${b.reservationTime}`)-new Date(`${a.reservationDate}T${a.reservationTime}`));sR.forEach(r=>{const row=document.createElement('tr');row.innerHTML=`<td>${r.reservationDate} ${r.reservationTime}</td><td>${r.patientIdRME}</td><td>${r.patientName}</td><td>${r.serviceName}</td><td>${r.therapist}</td><td>Rp ${r.price.toLocaleString('id-ID')}</td><td><button class="btn-danger" onclick="deleteReservation(${r.id})">Hapus</button></td>`;tB.appendChild(row);});}
            window.deleteReservation=function(id){if(confirm('Hapus reservasi ini?')){reservations=reservations.filter(r=>r.id!==id);saveAllData();renderAll();}}
            window.deletePatient=function(idRME){if(confirm('PERINGATAN: Menghapus pasien ini juga akan menghapus SEMUA RIWAYAT RESERVASINYA. Lanjutkan?')){patients=patients.filter(p=>p.idRME!==idRME);reservations=reservations.filter(r=>r.patientIdRME!==idRME);saveAllData();renderAll();}}
            function getFilterDates(f){const n=new Date();let s,e;switch(f){case 'harian':s=new Date(n.setHours(0,0,0,0));e=new Date(n.setHours(23,59,59,999));break;case 'pekanan':const d=n.getDay();const diff=n.getDate()-d+(d===0?-6:1);s=new Date(new Date().setDate(diff));s.setHours(0,0,0,0);e=new Date(s);e.setDate(e.getDate()+6);e.setHours(23,59,59,999);break;case 'bulanan':s=new Date(n.getFullYear(),n.getMonth(),1);e=new Date(n.getFullYear(),n.getMonth()+1,0,23,59,59,999);break;case 'tahunan':s=new Date(n.getFullYear(),0,1);e=new Date(n.getFullYear(),11,31,23,59,59,999);break;}return{startDate:s,endDate:e};}
            function updateJamSibukChart(d){const c=document.getElementById('jamSibukChart').getContext('2d');const jC=Array(24).fill(0);d.forEach(r=>{if(r.reservationTime){const j=parseInt(r.reservationTime.split(':')[0]);jC[j]++;}});const l=Array.from({length:24},(_,i)=>`${String(i).padStart(2,'0')}:00`);if(jamSibukChart)jamSibukChart.destroy();jamSibukChart=new Chart(c,{type:'bar',data:{labels:l,datasets:[{label:'Jumlah Kunjungan',data:jC,backgroundColor:'rgba(22, 160, 133, 0.5)',borderColor:'rgba(22, 160, 133, 1)',borderWidth:1}]},options:{scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}}});}
            function updateDomisiliRanking(d){const dC={};const pM=new Map(patients.map(p=>[p.idRME,p]));d.forEach(r=>{const p=pM.get(r.patientIdRME);if(p&&p.address){const dom=p.address.trim();dC[dom]=(dC[dom]||0)+1;}});const sD=Object.entries(dC).sort((a,b)=>b[1]-a[1]);const tB=document.getElementById('tabel-domisili').querySelector('tbody');tB.innerHTML='';sD.slice(0,5).forEach(([dom,cnt])=>{const row=tB.insertRow();row.innerHTML=`<td>${dom}</td><td>${cnt}</td>`;});}
            function updateUsiaRanking(d){const aG={'0-5':0,'6-17':0,'18-30':0,'31-45':0,'46+':0,'Lainnya':0};const pM=new Map(patients.map(p=>[p.idRME,p]));function getAge(dob){if(!dob)return null;const bD=new Date(dob);const tD=new Date();let a=tD.getFullYear()-bD.getFullYear();const m=tD.getMonth()-bD.getMonth();if(m<0||(m===0&&tD.getDate()<bD.getDate())){a--;}return a;}d.forEach(r=>{const p=pM.get(r.patientIdRME);if(p){const a=getAge(p.dob);if(a!==null){if(a>=0&&a<=5)aG['0-5']++;else if(a>=6&&a<=17)aG['6-17']++;else if(a>=18&&a<=30)aG['18-30']++;else if(a>=31&&a<=45)aG['31-45']++;else if(a>=46)aG['46+']++;else aG['Lainnya']++;}else{aG['Lainnya']++;}}});const tB=document.getElementById('tabel-usia').querySelector('tbody');tB.innerHTML='';Object.entries(aG).forEach(([grp,cnt])=>{const row=tB.insertRow();row.innerHTML=`<td>${grp} tahun</td><td>${cnt}</td>`;});}
            function updateKeluhanRanking(d){const kC={};d.forEach(r=>{if(r.complaint&&r.complaint.trim()!==''){const k=r.complaint.trim().toLowerCase();kC[k]=(kC[k]||0)+1;}});const sK=Object.entries(kC).sort((a,b)=>b[1]-a[1]);const tB=document.getElementById('tabel-keluhan').querySelector('tbody');tB.innerHTML='';sK.slice(0,5).forEach(([k,cnt])=>{const row=tB.insertRow();const fK=k.charAt(0).toUpperCase()+k.slice(1);row.innerHTML=`<td>${fK}</td><td>${cnt}</td>`;});}
            function handleBackup(){const d={services,patients,reservations,therapists};const s=JSON.stringify(d,null,2);const b=new Blob([s],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;const t=new Date().toISOString().slice(0,10);a.download=`backup_klinik_nabilah_${t}.json`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);alert('Backup berhasil dibuat!');}
            function handleRestore(){const fI=document.getElementById('file-restore');if(fI.files.length===0){alert('Pilih file backup.');return;}if(confirm('Restore akan menimpa data saat ini. Lanjutkan?')){const f=fI.files[0];const r=new FileReader();r.onload=function(e){try{const d=JSON.parse(e.target.result);if(d.services&&d.patients&&d.reservations&&d.therapists){services=d.services;patients=d.patients;reservations=d.reservations;therapists=d.therapists;saveAllData();alert('Data berhasil direstore! Aplikasi akan dimuat ulang.');location.reload();}else{alert('Format file backup tidak valid.');}}catch(err){alert('Error membaca file.');}};r.readAsText(f);}}
            function handleReset(){if(confirm('ANDA YAKIN? Tindakan ini tidak dapat diurungkan.')){if(confirm('KONFIRMASI TERAKHIR: Hapus SEMUA data aplikasi?')){localStorage.clear();alert('Semua data telah direset. Aplikasi akan dimuat ulang.');location.reload();}}}
            function togglePatientForm(e){const isNew=e.target.value==='baru';document.getElementById('form-pasien-baru').style.display=isNew?'block':'none';document.getElementById('form-pasien-lama').style.display=isNew?'none':'block';if(!isNew)populatePasienLamaSelect();}
            function updateTreatmentOptions(e){const tS=document.getElementById('treatment-reservasi');tS.innerHTML='<option value="">-- Pilih Treatment --</option>';const s=services.find(s=>s.id===parseInt(e.target.value));if(s){s.treatments.forEach(t=>{const o=document.createElement('option');o.value=t.id;o.dataset.price=t.price;o.textContent=`${t.name} (Rp ${t.price.toLocaleString('id-ID')})`;tS.appendChild(o);});}}

            initializeApp();
        });
    </script>
</body>
</html>
